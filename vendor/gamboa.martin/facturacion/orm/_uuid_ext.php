<?php
namespace gamboamartin\facturacion\models;


use base\orm\_modelo_parent;
use gamboamartin\errores\errores;
use stdClass;

class _uuid_ext extends _modelo_parent{

    protected _relacion $modelo_relacion;

    public function alta_bd(array $keys_integra_ds = array('codigo', 'descripcion')): array|stdClass
    {


        $registro = $this->maqueta_registro(modelo_relacion: $this->modelo_relacion,registro:  $this->registro);
        if(errores::$error){
            return $this->error->error(mensaje: 'Error al integrar descripcion',data:  $registro);
        }

        $this->registro = $registro;

        $r_alta_bd = parent::alta_bd(keys_integra_ds: $keys_integra_ds); // TODO: Change the autogenerated stub
        if(errores::$error){
            return $this->error->error(mensaje: 'Error al insertar',data:  $r_alta_bd);
        }
        return $r_alta_bd;
    }

    private function data_relacion(_relacion $modelo_relacion, array $registro){
        $fc_uuid = (new fc_uuid(link: $this->link))->registro(registro_id: $registro['fc_uuid_id'], retorno_obj: true);
        if(errores::$error){
            return $this->error->error(mensaje: 'Error al obtener fc_uuid',data:  $fc_uuid);
        }
        $fc_relacion = $modelo_relacion->registro(registro_id: $registro[$modelo_relacion->key_id], retorno_obj: true);
        if(errores::$error){
            return $this->error->error(mensaje: 'Error al obtener fc_uuid',data:  $fc_relacion);
        }

        $data = new stdClass();
        $data->fc_uuid = $fc_uuid;
        $data->fc_relacion = $fc_relacion;

        return $data;
    }

    private function descripcion(stdClass $fc_relacion, stdClass $fc_uuid, string $key_relacion_descripcion): string
    {
        $descripcion = $fc_uuid->fc_uuid_descripcion;
        $descripcion .= ' '.$fc_relacion->$key_relacion_descripcion;
        return trim($descripcion);
    }

    private function integra_descripcion(stdClass $fc_relacion, stdClass $fc_uuid, _relacion $modelo_relacion, array $registro){
        $key_relacion_descripcion = $modelo_relacion->tabla.'_descripcion';
        if(!isset($registro['descripcion'])){

            $descripcion = $this->descripcion(fc_relacion: $fc_relacion,fc_uuid:  $fc_uuid,key_relacion_descripcion:  $key_relacion_descripcion);
            if(errores::$error){
                return $this->error->error(mensaje: 'Error al obtener descripcion',data:  $descripcion);
            }

            $registro['descripcion'] = $descripcion;
        }
        return $registro;
    }

    private function maqueta_registro(_relacion $modelo_relacion, array $registro){
        $data = $this->data_relacion(modelo_relacion: $modelo_relacion,registro:  $registro);
        if(errores::$error){
            return $this->error->error(mensaje: 'Error al obtener datos de relacion',data:  $data);
        }

        $registro = $this->integra_descripcion(fc_relacion: $data->fc_relacion,fc_uuid:  $data->fc_uuid,
            modelo_relacion:  $modelo_relacion,registro:  $registro);
        if(errores::$error){
            return $this->error->error(mensaje: 'Error al integrar descripcion',data:  $registro);
        }

        return $registro;
    }

}
